---
// components/WeatherIcon.astro
---
<span class="weather-sep">&middot;&nbsp;</span>
<span class="weather-icon" data-weather="sun"><svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 2h-2v6h2V2zm0 14h-2v6h2v-6zm9-5v2h-6v-2h6zM8 13v-2H2v2h6zm7-6h2v2h-2V7zm4-2h-2v2h2V5zM9 7H7v2h2V7zM5 5h2v2H5V5zm10 12h2v2h2v-2h-2v-2h-2v2zm-8 0v-2h2v2H7v2H5v-2h2z" fill="currentColor"/></svg></span>
<span class="weather-icon" data-weather="partly-cloudy"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24"><path d="M11 0h2v4h-2V0Zm1 12H8v2H4v2H2v4h2v2h10v-2h2v-4h-2v-2h-2v-2Zm0 2v2h2v4H4v-4h4v2h2v-2H8v-2h4ZM8 6h6v2H8V6Zm0 2v2H6V8h2Zm8 2h-2V8h2v2Zm0 0h2v2h-2v-2Zm4-8h2v2h-2V2Zm0 2v2h-2V4h2ZM2 2h2v2H2V2Zm2 2h2v2H4V4Zm20 7h-4v2h4v-2Z"/></svg></span>
<span class="weather-icon" data-weather="cloud"><svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16 4h-6v2H8v2H4v2H2v2H0v6h2v2h20v-2h2v-6h-2v-2h-2V8h-2V6h-2V4zm2 8h4v6H2v-6h2v-2h4v2h2v-2H8V8h2V6h6v2h2v4zm0 0v2h-2v-2h2z" fill="currentColor"/></svg></span>
<span class="weather-icon" data-weather="rain"><svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 2h-2v2H9v4H7v4H5v6h2v2h2v2h6v-2h2v-2h2v-6h-2V8h-2V4h-2V2zm0 2v4h2v4h2v6h-2v2H9v-2H7v-6h2V8h2V4h2z" fill="currentColor"/></svg></span>
<span class="weather-icon" data-weather="snow"><svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 2h-2v4H9V4H7v2h2v2h2v3H8V9H6V7H4v2h2v2H2v2h4v2H4v2h2v-2h2v-2h3v3H9v2H7v2h2v-2h2v4h2v-4h2v2h2v-2h-2v-2h-2v-3h3v2h2v2h2v-2h-2v-2h4v-2h-4V9h2V7h-2v2h-2v2h-3V8h2V6h2V4h-2v2h-2V2z" fill="currentColor"/></svg></span>
<span class="weather-icon" data-weather="lightning"><svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 1h2v8h8v4h-2v-2h-8V5h-2V3h2V1zM8 7V5h2v2H8zM6 9V7h2v2H6zm-2 2V9h2v2H4zm10 8v2h-2v2h-2v-8H2v-4h2v2h8v6h2zm2-2v2h-2v-2h2zm2-2v2h-2v-2h2zm0 0h2v-2h-2v2z" fill="currentColor"/></svg></span>
<span class="weather-icon" data-weather="wind"><svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 3H8v2h4v2H2v2h12V3h-2zm10 8V7h-6v2h4v2H2v2h20v-2zM2 17v-2h14v6h-6v-2h4v-2H2z" fill="currentColor"/></svg></span>
<span class="weather-icon" data-weather="night-clear"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24"><path d="M6 2h8v2h-2v2h-2V4H6V2ZM4 6V4h2v2H4Zm0 10H2V6h2v10Zm2 2H4v-2h2v2Zm2 2H6v-2h2v2Zm10 0v2H8v-2h10Zm2-2v2h-2v-2h2Zm-2-4v-2h2v-2h2v8h-2v-4h-2Zm-6 0h6v2h-6v-2Zm-2-2h2v2h-2v-2Zm0 0V6H8v6h2Zm8-10h2v2h2v2h-2v2h-2V6h-2V4h2V2Z"/></svg></span>
<span class="weather-icon" data-weather="night-partly-cloudy"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24"><path d="M18 2h-8v2H8v2H6v4h2V6h2V4h4v2h-2v4h2v2h4v-2h2v4h-2v2h2v-2h2V6h-2v2h-2v2h-4V6h2V4h2V2ZM8 14v-2h4v2H8Zm0 2v-2H4v2H2v4h2v2h10v-2h2v-4h-2v-2h-2v2h2v4H4v-4h4Zm0 0h2v2H8v-2Z"/></svg></span>

<style lang="scss">
  @use '../styles/abstracts' as *;

  .weather-icon {
    display: none;
    width: 1.75em;
    height: 1.75em;
    position: relative;
    cursor: default;

    svg {
      width: 100%;
      height: 100%;
    }

    &.active {
      display: inline-flex;
    }

    &[data-tooltip]::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%);
      font-family: 'Sixtyfour', monospace;
      font-size: 0.5rem;
      letter-spacing: 0.03em;
      word-spacing: -0.3em;
      line-height: 1.4;
      white-space: nowrap;
      text-transform: capitalize;
      color: var(--color-bg);
      background: var(--color-text);
      padding: 4px 8px;
      pointer-events: none;
      opacity: 0;
      transition: opacity $transition-fast;
    }

    &[data-tooltip]::before {
      content: '';
      position: absolute;
      bottom: calc(100% + 2px);
      left: 50%;
      transform: translateX(-50%);
      width: 10px;
      height: 6px;
      background: var(--color-text);
      clip-path: polygon(50% 100%, 0 0, 100% 0);
      pointer-events: none;
      opacity: 0;
      transition: opacity $transition-fast;
    }

    &[data-tooltip]:hover::before,
    &[data-tooltip]:hover::after {
      opacity: 1;
    }

    @include mobile {
      &, &.active {
        display: none;
      }
    }
  }

  .weather-sep {
    @include mobile {
      display: none;
    }
  }
</style>

<script>
  const isNight = () => {
    const hour = new Date().getHours();
    return hour < 6 || hour >= 20;
  };

  function weatherCodeToIcon(code: number): { icon: string; label: string } {
    if (code === 0) return isNight() ? { icon: 'night-clear', label: 'Clear' } : { icon: 'sun', label: 'Sunny' };
    if (code <= 2) return isNight() ? { icon: 'night-partly-cloudy', label: 'Partly Cloudy' } : { icon: 'partly-cloudy', label: 'Partly Cloudy' };
    if (code === 3) return { icon: 'cloud', label: 'Cloudy' };
    if (code <= 49) return { icon: 'cloud', label: 'Foggy' };
    if (code <= 69) return { icon: 'rain', label: 'Rainy' };
    if (code <= 79) return { icon: 'snow', label: 'Snowy' };
    if (code <= 82) return { icon: 'rain', label: 'Rainy' };
    if (code <= 86) return { icon: 'snow', label: 'Snowy' };
    if (code <= 99) return { icon: 'lightning', label: 'Stormy' };
    return { icon: 'cloud', label: 'Cloudy' };
  }

  fetch('https://api.open-meteo.com/v1/forecast?latitude=30.27&longitude=-97.74&current=weather_code,temperature_2m&temperature_unit=fahrenheit')
    .then(res => res.json())
    .then(data => {
      const code = data.current.weather_code;
      const temp = Math.round(data.current.temperature_2m);
      const { icon, label } = weatherCodeToIcon(code);
      const el = document.querySelector(`.weather-icon[data-weather="${icon}"]`);
      if (el) {
        el.classList.add('active');
        el.setAttribute('data-tooltip', `${label}, ${temp}Â°F`);
      }
    })
    .catch(() => {});
</script>
